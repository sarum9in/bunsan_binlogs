#include <bunsan/binlogs/LogFactory.hpp>

#include <google/protobuf/descriptor.h>

#include <boost/filesystem/path.hpp>
#include <boost/format.hpp>

#include <iostream>

using namespace bunsan::binlogs;

int main(int argc, char *argv[])
{
    if (argc == 1) {
        std::cerr << boost::format(R"EOF(Usage: %1% [log file]...

Produces readable text representation of each binary log file
generated by bunsan::binlogs library.
)EOF") % argv[0] << std::flush;
        return 200;
    }

    for (int i = 1; i < argc; ++i) {
        const boost::filesystem::path path = argv[i];
        std::string error;

        auto logReader = openReadOnly(path, &error);
        if (!logReader) {
            std::cerr << error << std::endl;
            return 7;
        }

        while (logReader->usable()) {
            const auto message = logReader->read(&error);
            if (message) {
                std::cout << message->GetDescriptor()->full_name() << '\n' <<
                             message->DebugString() << '\n';
            } else {
                if (!logReader->eof()) {
                    std::cerr << error << std::endl;
                    if (!logReader->usable()) {
                        return 4;
                    }
                }
            }
        }
        if (!logReader->eof()) {
            return 1;
        }
    }
}
